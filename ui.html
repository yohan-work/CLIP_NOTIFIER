<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), clipboard-write=(), display-capture=(), geolocation=(), accelerometer=(), gyroscope=(), magnetometer=(), payment=(), usb=()"  >
  <title>Clip Notifier</title>
  <script>
    // ë¸Œë¼ìš°ì € ê¶Œí•œ ì²´í¬ ë°©ì§€
    if (typeof navigator !== 'undefined' && navigator.permissions) {
      const originalQuery = navigator.permissions.query;
      navigator.permissions.query = function() {
        return Promise.resolve({ state: 'denied' });
      };
    }

    // í”ŒëŸ¬ê·¸ì¸ ì¢…ë£Œ ì‹œ ì¸ë””ì¼€ì´í„° ì •ë¦¬
    window.addEventListener('beforeunload', function() {
      parent.postMessage({ 
        pluginMessage: { type: 'cleanup-before-close' } 
      }, '*');
    });

    // í˜ì´ì§€ ìˆ¨ê¹€ ì‹œì—ë„ ì •ë¦¬ (iOS ë“±ì—ì„œ beforeunloadê°€ ë™ì‘í•˜ì§€ ì•Šì„ ë•Œ)
    window.addEventListener('pagehide', function() {
      parent.postMessage({ 
        pluginMessage: { type: 'cleanup-before-close' } 
      }, '*');
    });

    // ë¸Œë¼ìš°ì € ì°½ ë‹«í˜ ê°ì§€
    window.addEventListener('unload', function() {
      parent.postMessage({ 
        pluginMessage: { type: 'cleanup-before-close' } 
      }, '*');
    });
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 12px;
      background: #ffffff;
      color: #1d1d1d;
      padding: 16px;
      overflow-x: hidden;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e5e5e5;
    }

    .header h1 {
      font-size: 14px;
      font-weight: 600;
      color: #1d1d1d;
    }

    .header-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .scan-btn {
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .scan-btn:hover {
      background: #1592e6;
    }

    .hide-btn {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
    }

    .hide-btn:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
    }

    .controls {
      display: flex;
      justify-content: center;
      margin-bottom: 16px;
    }

    .control-btn {
      background: #f0f0f0;
      border: 1px solid #d9d9d9;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 160px;
    }

    .control-btn:hover {
      background: #e0e0e0;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .control-btn.active {
      background: #18a0fb;
      color: white;
      border-color: #18a0fb;
      box-shadow: 0 2px 8px rgba(24, 160, 251, 0.3);
    }

    .status {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 16px;
      text-align: center;
    }

    .status.warning {
      background: #fff3cd;
      border-color: #ffeaa7;
      color: #856404;
    }

    .status.success {
      background: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }

    .status.info {
      background: #d1ecf1;
      border-color: #bee5eb;
      color: #0c5460;
    }

    .frame-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .frame-item {
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      margin-bottom: 12px;
      overflow: hidden;
      transition: border-color 0.2s;
    }

    .frame-item:hover {
      border-color: #18a0fb;
    }

    .frame-item.highlighted {
      border-color: #18a0fb;
      background: #f0f8ff;
      box-shadow: 0 2px 8px rgba(24, 160, 251, 0.15);
    }

    .frame-details {
      background: #e8f4fd;
      border: 1px solid #b3d9ff;
      border-radius: 6px;
      padding: 12px;
      margin: 8px 12px 12px;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        max-height: 0;
        padding: 0 12px;
      }
      to {
        opacity: 1;
        max-height: 100px;
        padding: 12px;
      }
    }

    .detail-header {
      font-weight: 600;
      color: #0066cc;
      font-size: 11px;
      margin-bottom: 4px;
    }

    .detail-note {
      font-size: 10px;
      color: #4a5568;
      line-height: 1.4;
      margin-bottom: 8px;
    }

    .expand-btn {
      background: #18a0fb;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 10px;
      cursor: pointer;
      transition: background 0.2s;
      width: 100%;
    }

    .expand-btn:hover {
      background: #1592e6;
    }

    .frame-header {
      background: #f8f9fa;
      padding: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .frame-header:hover {
      background: #e9ecef;
    }

    .frame-title {
      font-weight: 600;
      color: #1d1d1d;
      margin-bottom: 2px;
    }

    .frame-subtitle {
      font-size: 10px;
      color: #6c757d;
    }

    .frame-icon {
      width: 16px;
      height: 16px;
      background: #ffc107;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: white;
      font-weight: bold;
    }

    .clipped-items {
      padding: 0 12px 12px;
    }

    .clipped-item {
      background: #ffffff;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 6px;
      font-size: 11px;
    }

    .clipped-item:last-child {
      margin-bottom: 0;
    }

    .clipped-name {
      font-weight: 500;
      color: #dc3545;
      margin-bottom: 2px;
    }

    .clipped-details {
      color: #6c757d;
      font-size: 10px;
    }

    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: #6c757d;
    }

    .empty-icon {
      font-size: 32px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .footer {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid #e5e5e5;
      text-align: center;
    }

    .close-btn {
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 11px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .close-btn:hover {
      background: #5a6268;
    }

    .loading {
      text-align: center;
      color: #6c757d;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ” Clip Notifier</h1>
    <div class="header-buttons">
      <button class="hide-btn" id="hideIndicators">ğŸ§¹ ì¸ë””ì¼€ì´í„° ì œê±°</button>
      <button class="scan-btn" id="scanBtn">ìŠ¤ìº”</button>
    </div>
  </div>

  <div class="controls">
    <button class="control-btn active" id="showIndicators">ğŸ“ ì¸ë””ì¼€ì´í„° í‘œì‹œ</button>
  </div>

  <div class="status" id="status">
    <div class="loading">í´ë¦½ëœ ìš”ì†Œë“¤ì„ ê²€ìƒ‰ ì¤‘...</div>
  </div>

  <div class="frame-list" id="frameList"></div>

  <div class="empty-state" id="emptyState" style="display: none;">
    <div class="empty-icon">âœ…</div>
    <div><strong>í´ë¦½ëœ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤!</strong></div>
    <div>ëª¨ë“  í”„ë ˆì„ì˜ ì½˜í…ì¸ ê°€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë˜ê³  ìˆìŠµë‹ˆë‹¤.</div>
  </div>

  <div class="footer">
    <button class="close-btn" id="closeBtn">ğŸ§¹ ì¸ë””ì¼€ì´í„° ì •ë¦¬ í›„ ë‹«ê¸°</button>
  </div>

  <script>
    let clippedData = [];
    let indicatorsVisible = false;

    // DOM ìš”ì†Œë“¤
    const scanBtn = document.getElementById('scanBtn');
    const showIndicatorsBtn = document.getElementById('showIndicators');
    const hideIndicatorsBtn = document.getElementById('hideIndicators');
    const status = document.getElementById('status');
    const frameList = document.getElementById('frameList');
    const emptyState = document.getElementById('emptyState');
    const closeBtn = document.getElementById('closeBtn');

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    scanBtn.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'scan' } }, '*');
      updateStatus('loading', 'í˜ì´ì§€ ìŠ¤ìº” ì¤‘... ëŒ€ìš©ëŸ‰ íŒŒì¼ì˜ ê²½ìš° ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      scanBtn.disabled = true;
      scanBtn.textContent = 'ìŠ¤ìº” ì¤‘...';
    });

    showIndicatorsBtn.addEventListener('click', () => {
      if (!indicatorsVisible) {
        parent.postMessage({ pluginMessage: { type: 'show-indicators' } }, '*');
        indicatorsVisible = true;
        updateControlButtons();
        updateStatus('info', 'ì¸ë””ì¼€ì´í„°ë¥¼ í‘œì‹œí•˜ê³  ìˆìŠµë‹ˆë‹¤...');
      }
    });

    hideIndicatorsBtn.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'hide-indicators' } }, '*');
      indicatorsVisible = false;
      updateControlButtons();
      updateStatus('success', 'ğŸ§¹ ëª¨ë“  ì¸ë””ì¼€ì´í„°ê°€ ì™„ì „íˆ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

    closeBtn.addEventListener('click', () => {
      parent.postMessage({ pluginMessage: { type: 'close' } }, '*');
    });

    // ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateControlButtons() {
      if (indicatorsVisible) {
        showIndicatorsBtn.classList.add('active');
        showIndicatorsBtn.textContent = 'âœ… ì¸ë””ì¼€ì´í„° í‘œì‹œë¨';
        hideIndicatorsBtn.style.display = 'block';
      } else {
        showIndicatorsBtn.classList.remove('active');
        showIndicatorsBtn.textContent = 'ğŸ“ ì¸ë””ì¼€ì´í„° í‘œì‹œ';
        hideIndicatorsBtn.style.display = 'none';
      }
    }

    // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
    function updateStatus(type, message) {
      status.className = `status ${type}`;
      status.innerHTML = message;
    }

    // í”„ë ˆì„ ëª©ë¡ ë Œë”ë§
    function renderFrameList(data) {
      frameList.innerHTML = '';
      
      if (data.length === 0) {
        frameList.style.display = 'none';
        emptyState.style.display = 'block';
        updateStatus('success', 'í´ë¦½ëœ ì½˜í…ì¸ ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
      }

      frameList.style.display = 'block';
      emptyState.style.display = 'none';
      
      data.forEach(frame => {
        const frameElement = createFrameElement(frame);
        frameList.appendChild(frameElement);
      });

      const totalClipped = data.reduce((sum, frame) => sum + frame.clippedCount, 0);
      updateStatus('warning', `${data.length}ê°œ í”„ë ˆì„ì—ì„œ ${totalClipped}ê°œì˜ í´ë¦½ëœ ìš”ì†Œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.`);
    }

    // ê°œë³„ í”„ë ˆì„ ìš”ì†Œ ìƒì„±
    function createFrameElement(frame) {
      const frameDiv = document.createElement('div');
      frameDiv.className = 'frame-item';

      const headerDiv = document.createElement('div');
      headerDiv.className = 'frame-header';
      headerDiv.addEventListener('click', () => {
        parent.postMessage({ 
          pluginMessage: { 
            type: 'focus-frame', 
            frameId: frame.frameId 
          } 
        }, '*');
      });

      headerDiv.innerHTML = `
        <div>
          <div class="frame-title">${frame.frameName}</div>
          <div class="frame-subtitle">${frame.clippedCount}ê°œì˜ í´ë¦½ëœ ìš”ì†Œ</div>
        </div>
        <div class="frame-icon">${frame.clippedCount}</div>
      `;

      const clippedItemsDiv = document.createElement('div');
      clippedItemsDiv.className = 'clipped-items';

      frame.clippedChildren.forEach(child => {
        const childDiv = document.createElement('div');
        childDiv.className = 'clipped-item';
        childDiv.innerHTML = `
          <div class="clipped-name">${child.name}</div>
          <div class="clipped-details">
            íƒ€ì…: ${child.type} | í´ë¦½ëœ ë†’ì´: ${child.clippedHeight}px
          </div>
        `;
        clippedItemsDiv.appendChild(childDiv);
      });

      frameDiv.appendChild(headerDiv);
      frameDiv.appendChild(clippedItemsDiv);

      return frameDiv;
    }

    // í”ŒëŸ¬ê·¸ì¸ ë©”ì‹œì§€ ìˆ˜ì‹ 
    onmessage = (event) => {
      const { type, data, message } = event.data.pluginMessage;
      
      if (type === 'scan-started') {
        updateStatus('loading', 'í˜ì´ì§€ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...');
      } else if (type === 'clipped-elements') {
        clippedData = data;
        renderFrameList(data);
        // ìŠ¤ìº” ì™„ë£Œ ì‹œ ë²„íŠ¼ ë³µì›
        scanBtn.disabled = false;
        scanBtn.textContent = 'ìŠ¤ìº”';
      } else if (type === 'indicators-created') {
        updateControlButtons(); // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateStatus('success', 'âœ… ì¸ë””ì¼€ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤! íŒŒë€ ì›ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì •ë³´ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      } else if (type === 'show-frame-details') {
        showFrameDetails(data);
        updateStatus('info', `ğŸ“‹ ${data.frameName}ì˜ í´ë¦½ëœ ìš”ì†Œ ìƒì„¸ ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.`);
      } else if (type === 'frame-expanded') {
        updateStatus('success', message);
        updateExpandButtons('í™•ì¥ë¨');
      } else if (type === 'frame-restored') {
        updateStatus('info', message);
        updateExpandButtons('ë³µì›ë¨');
      } else if (type === 'error') {
        updateStatus('warning', message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        // ì—ëŸ¬ ì‹œì—ë„ ë²„íŠ¼ ë³µì›
        scanBtn.disabled = false;
        scanBtn.textContent = 'ìŠ¤ìº”';
      }
    };

    // í”„ë ˆì„ ìƒì„¸ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
    function showFrameDetails(frameData) {
      // ê¸°ì¡´ í”„ë ˆì„ ë¦¬ìŠ¤íŠ¸ì—ì„œ í•´ë‹¹ í”„ë ˆì„ ì°¾ê¸° ë° í•˜ì´ë¼ì´íŠ¸
      const frameItems = document.querySelectorAll('.frame-item');
      
      frameItems.forEach(item => {
        item.classList.remove('highlighted');
        const header = item.querySelector('.frame-header');
        const titleElement = header.querySelector('.frame-title');
        
        if (titleElement && titleElement.textContent === frameData.frameName) {
          item.classList.add('highlighted');
          
                     // ìƒì„¸ ì •ë³´ê°€ ì´ë¯¸ í™•ì¥ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ í™•ì¥
           const detailsDiv = item.querySelector('.frame-details');
           if (!detailsDiv) {
             const newDetailsDiv = document.createElement('div');
             newDetailsDiv.className = 'frame-details';
             newDetailsDiv.innerHTML = `
               <div class="detail-header">ğŸ” ì¸ë””ì¼€ì´í„° í´ë¦­ìœ¼ë¡œ ìƒì„¸ ì •ë³´ í‘œì‹œ</div>
               <div class="detail-note">ì´ ${frameData.clippedCount}ê°œ ìš”ì†Œê°€ í•˜ë‹¨ì—ì„œ í´ë¦½ë˜ì—ˆìŠµë‹ˆë‹¤</div>
               <button class="expand-btn" onclick="expandFrame('${frameData.frameId}')">
                 ğŸ“ ì„ì‹œë¡œ í”„ë ˆì„ í™•ì¥í•´ì„œ ë³´ê¸°
               </button>
             `;
             
             // ê¸°ì¡´ clipped-items ì•ì— ì‚½ì…
             const clippedItems = item.querySelector('.clipped-items');
             item.insertBefore(newDetailsDiv, clippedItems);
           }
          
          // ìŠ¤í¬ë¡¤í•´ì„œ í•´ë‹¹ í•­ëª©ì´ ë³´ì´ë„ë¡
          item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      });
    }

         // í”„ë ˆì„ ì„ì‹œ í™•ì¥ í•¨ìˆ˜
     function expandFrame(frameId) {
       parent.postMessage({ 
         pluginMessage: { 
           type: 'expand-frame-temporarily', 
           frameId: frameId 
         } 
       }, '*');
       updateStatus('info', 'í”„ë ˆì„ì„ ì„ì‹œë¡œ í™•ì¥í•˜ì—¬ í´ë¦½ëœ ë¶€ë¶„ì„ í‘œì‹œí•©ë‹ˆë‹¤...');
     }

     // í™•ì¥ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
     function updateExpandButtons(status) {
       const expandBtns = document.querySelectorAll('.expand-btn');
       expandBtns.forEach(btn => {
         if (status === 'í™•ì¥ë¨') {
           btn.textContent = 'ğŸ“ ì›ë³¸ í¬ê¸°ë¡œ ë³µì›í•˜ê¸°';
           btn.style.background = '#22c55e';
         } else if (status === 'ë³µì›ë¨') {
           btn.textContent = 'ğŸ“ ì„ì‹œë¡œ í”„ë ˆì„ í™•ì¥í•´ì„œ ë³´ê¸°';
           btn.style.background = '#18a0fb';
         }
       });
     }

     // ì´ˆê¸° ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ìƒíƒœ ì„¤ì •
     updateControlButtons();
  </script>
</body>
</html> 